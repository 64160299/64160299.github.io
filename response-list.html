<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Response List</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.datatables.net/2.3.2/css/dataTables.bootstrap5.css">
</head>

<body>
  <div class="container py-4">
    <div class="row justify-items-center align-items-center mb-3">
      <button class="btn btn-secondary me-2 col-auto" onclick="history.back()">
        <span aria-hidden="true">&lt;</span>
      </button>
      <h2 id="header" class="col-auto">Loading ...</h2>
    </div>

    <h3 class="text-danger mb-4">อัปเดตข้อมูลล่าสุด (Latest): 20/08/2025: 3:05 PM</h3>
    <h3 class="text-danger mb-4">Website ไม่ได้มีการอัปเดตแบบ Realtime หากตอบแบบสอบถามแล้ว จะยังไม่เห็นการตอบกลับของตัวเองบนหน้าเว็ป</h3>

    <table id="t-url" class="table table-striped table-hover my-2">
      <thead>
        <tr>
          <th style="width: 15%;" class="text-center">ลำดับ</th>
          <th>รายการการตอบกลับ</th>
          <th style="width: 20%">วันที่ตอบกลับ</th>
          <th style="width: 30%;" class="text-center">ดูผลการตอบกลับ</th>
        </tr>
      </thead>

      <tbody id="t-url-body" class="table-group-divider">
      </tbody>

    </table>
  </div>

  <script>
    (async function () {
      const urlParams = new URLSearchParams(window.location.search);
      const formId = urlParams.get('form_id');
      const h = document.getElementById("header")

      if (!formId) {
        h.innerText = "Not found";
        return;
      }

      try {
        // Fetch JSON from your Apps Script Web App
        const response = await fetch(`./responses/${formId}.json`);
        const data = await response.json();

        if (!data.responses || data.responses.length === 0) {
          h.innerText = "Not found";
          return;
        }

        h.innerText = data.title.split('-')[0];
        const t = document.getElementById("t-url-body")

        data.responses.forEach((resp, rIndex) => {
          const row = document.createElement("tr");
          row.className = "align-middle";
          const d = new Date(resp.timestamp);

          const formatted =
            d.getDate().toString().padStart(2, '0') + "/" +
            (d.getMonth() + 1).toString().padStart(2, '0') + "/" +
            d.getFullYear() + " " +
            d.getHours().toString().padStart(2, '0') + ":" +
            d.getMinutes().toString().padStart(2, '0');

          row.innerHTML = `
                    <td class="text-center">${rIndex + 1}</td>
                    <td>${resp.responseTitle.split('_').join(' ') || ""}</td>
                    <td>${formatted}</td>
                    <td class="text-center">
                        <div class="row row-cols-auto justify-content-center">
                            <div class="col"><a href="response.html?form_id=${data.formId}&response_id=${resp.responseId}" class="btn btn-success">Response</a></div>
                        </div>    
                    </td>
                `;
          t.appendChild(row);
        })
      } catch (e) {
        h.innerText = "Not found";
        console.error(e)
      }
    })()
  </script>
</body>

</html>